/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.6.4/userguide/java_library_plugin.html
 */

buildscript {
    // The Android Gradle plugin is only required when opening the android folder stand-alone.
    // This avoids unnecessary downloads and potential conflicts when the library is included as a
    // module dependency in an application project.
    if (project == rootProject) {
        ext {
            buildToolsVersion = "28.0.3"
            minSdkVersion = 16
            compileSdkVersion = 28
            targetSdkVersion = 28
        }
        repositories {
            google()
            jcenter()
        }
        dependencies {
            classpath 'com.android.tools.build:gradle:3.5.2'
            classpath("de.undercouch:gradle-download-task:4.0.2")
        }
    }
}

allprojects {
    repositories {
        jcenter()
        google()
        maven {
            // All of React Native (JS, Obj-C sources, Android binaries) is installed from npm
            url("$rootDir/../node_modules/react-native/android")
        }
    }
}

apply plugin: 'com.android.library'

def safeExtGet(prop, fallback) {
    rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
}

// 这个任务在 ReactAndroid 模块中定义了
// task downloadNdkBuildDependencies {}


task prepareNdkDependencies(type: GradleBuild) {
    dependsOn('ReactAndroid:prepareBoost')
    dependsOn('ReactAndroid:prepareDoubleConversion')
    dependsOn('ReactAndroid:prepareFolly')
    dependsOn('ReactAndroid:prepareGlog')
}


// ReactAndroid gradle.properties 定义
Properties ReactProperties = new Properties()
InputStream ReactPropertiesInputStream = new FileInputStream("../node_modules/" +
        "react-native/ReactAndroid/gradle.properties")
ReactProperties.load(ReactPropertiesInputStream)
ReactPropertiesInputStream.close()

// ReactAndroid 依赖库路径
String DepLibPath = new File('../node_modules/react-native/ReactAndroid/build/third-party-ndk')
        .getAbsolutePath()
String DepPreBuildSoPath = new File('build/ReactAndroid').getAbsolutePath()

task extractReactAndriodLib(type: Copy){
    def aarFile = file("../node_modules/react-native/android/com/facebook/react/" +
            "react-native/${ReactProperties.get('VERSION_NAME')}/" +
            "react-native-${ReactProperties.get('VERSION_NAME')}.aar")
    def output = file("${DepPreBuildSoPath}")
    output.mkdirs()

    from(zipTree(aarFile))
    into(output.getAbsolutePath())
    include('jni/**')
}

android {
    compileSdkVersion safeExtGet('compileSdkVersion', 28)
    buildToolsVersion safeExtGet('buildToolsVersion', '28.0.3')
    defaultConfig {
        minSdkVersion safeExtGet('minSdkVersion', 16)
        targetSdkVersion safeExtGet('targetSdkVersion', 28)

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

        externalNativeBuild {
            cmake {
                cppFlags "-I${DepLibPath}/boost/boost_${ReactProperties.getProperty('BOOST_VERSION')} " +
                        "-I${DepLibPath}/double-conversion " +
                        "-I${DepLibPath}/folly " +
                        "-I${DepLibPath}/glog/exported " +
                        "-DFOLLY_NO_CONFIG=1 " +
                        "-DFOLLY_HAVE_CLOCK_GETTIME=1 " +
                        "-DFOLLY_HAVE_MEMRCHR=1 " +
                        "-DFOLLY_USE_LIBCPP=1 " 
            }
        }
    }
    lintOptions {
        abortOnError false
        warning 'InvalidPackage'
    }
    compileOptions {
        targetCompatibility = 1.8
        sourceCompatibility = 1.8
    }

    tasks.withType(JavaCompile) {
        compileTask ->
            compileTask.dependsOn(prepareNdkDependencies, extractReactAndriodLib)
    }

    externalNativeBuild {
        cmake {
            path 'src/main/cpp/CMakeLists.txt'
        }
    }
}


dependencies {
    // Use JUnit test framework
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'androidx.test.ext:junit:1.1.0'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.1.1'

    implementation "com.facebook.react:react-native:+"
}
